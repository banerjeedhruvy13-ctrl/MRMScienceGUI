<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Science GUI</title>


<script src="https://unpkg.com/supersimpledev/react.js"></script>
<script src="https://unpkg.com/supersimpledev/react-dom.js"></script>
<script src="https://unpkg.com/supersimpledev/babel.js"></script>


<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script> 

<style>
* { box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; }
body { margin: 0; background: black; color: white; }


.header { display: flex; justify-content: space-between; align-items: center; padding: 16px 36px; }
.header-left { display: flex; align-items: center; gap: 14px; }
.logo { width: 52px; height: 52px; border-radius: 50%; }
.title { font-size: 18px; font-weight: bold; }
.nav { display: flex; gap: 16px; }
.nav button { background: none; border: 2px solid #888; color: white; padding: 8px 18px; border-radius: 8px; cursor: pointer; font-weight: bold; }
.nav button.active { background: white; color: black; }


.page { padding: 30px 40px; }


.page1-grid { display: grid; grid-template-columns: 3fr 2fr; grid-template-rows: auto auto; column-gap: 30px; row-gap: 10px; padding: 12px; }
.graph { grid-row: 1 / span 2; height: 475px; background: #dff3ff; border-radius: 30px; display: flex; align-items: center; justify-content: center; color: black; font-size: 24px; font-weight: bold; }
.microscope { height: 260px; background: #dff3ff; border-radius: 16px; display: flex; align-items: center; justify-content: center; color: black; font-size: 22px; font-weight: bold; }
.soil { border: 2px solid white; border-radius: 14px; padding: 16px; }
.soil-title { text-align: center; margin: 0; font-size: 20px; }
.soil-line { border-top: 1px solid white; margin: 11px -20px 15px; }
.soil p { margin: 6px 0; }


.sensor-grid { display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); gap: 30px; padding: 16px; }
.sensor { border: 2px solid #aaa; border-radius: 14px; min-height: 220px; display: flex; flex-direction: column; }
.sensor-title { text-align: center; padding: 14px; border-bottom: 2px solid #aaa; font-size: 18px; font-weight: bold; }
.sensor-body { padding: 20px; line-height: 2; }


@media (max-width: 900px) {
  .page1-grid, .sensor-grid { grid-template-columns: 1fr; }
}
/* ===== FLUOROMETER FLASH ===== */
/* ===== FLUOROMETER LATCHED STATES ===== */
/*.fluoro-red {
  background: #ff4d4d !important;
}

.fluoro-green {
  background: #3dff7a !important;
}*/
</style>
</head>

<body>

<div id="root"></div>

<script type="text/babel">

function useSensorSocket() {
  const [data, setData] = React.useState({});
  const socketRef = React.useRef(null);

  React.useEffect(() => {
    
    socketRef.current = io("http://10.0.0.67:5001");

    socketRef.current.on("sensor_data", (incoming) => {
      setData(incoming);
    });

    socketRef.current.on("connect", () => console.log("Connected to Pi"));
    socketRef.current.on("disconnect", () => console.log("Disconnected from Pi"));

    return () => {
      socketRef.current.disconnect();
    };
  }, []);

  return data;
}


function Header({ page, setPage }) {
  return (
    <div className="header">
      <div className="header-left">
        <img src="https://i.ibb.co/cSZV1McF/Whats-App-Image-2026-01-05-at-13-04-49.jpg" className="logo" />
        <div className="title">Science GUI</div>
      </div>

      <div className="nav">
        <button className={page === 1 ? "active" : ""} onClick={() => setPage(1)}>LEIA</button>
        <button className={page === 2 ? "active" : ""} onClick={() => setPage(2)}>HAN</button>
      </div>
    </div>
  );
}
const AS7341_PRESETS = {
  black: {
    F1: 2, F2: 3, F3: 4, F4: 6, F5: 8, F6: 10, F7: 14, F8: 17, Clear: 60, NIR: 38
  },
  red: {
    F1: 45, F2: 176, F3: 103, F4: 263, F5: 455, F6: 477, F7: 399, F8: 227, Clear: 1016, NIR: 240
  },
  sandy: {
    F1: 5, F2: 6, F3: 8, F4: 12, F5: 15, F6: 14, F7: 10, F8: 6, Clear: 70, NIR: 20
  },
  grey: {
    F1: 3, F2: 4, F3: 5, F4: 7, F5: 9, F6: 11, F7: 13, F8: 12, Clear: 55, NIR: 30
  },
  green: {
    F1: 3, F2: 5, F3: 9, F4: 14, F5: 18, F6: 16, F7: 12, F8: 8, Clear: 65, NIR: 22
},
  yellow: {
    F1: 4, F2: 7, F3: 12, F4: 18, F5: 22, F6: 20, F7: 15, F8: 9, Clear: 75, NIR: 28
}
};
function randomIntBetween(min, max) {
return Math.floor(Math.random() * (max - min + 1)) + min;
}
function Fluorometer() {
  const [clickCount, setClickCount] = React.useState(0);
  const [result, setResult] = React.useState(null);
  const [locked, setLocked] = React.useState(false);
  const [colorClass, setColorClass] = React.useState("");
  const [adcValue, setAdcValue] = React.useState(null);

  const timerRef = React.useRef(null);
  const adcTimerRef = React.useRef(null);

  const startAdcFluctuation = (state) => {
    if (adcTimerRef.current) clearInterval(adcTimerRef.current);

    adcTimerRef.current = setInterval(() => {
      if (state === "ABSENT") {
        setAdcValue(randomIntBetween(218, 220));
      } else if (state === "PRESENT") {
        setAdcValue(randomIntBetween(550, 552));
      }
    }, 1000);
  };

  const handleFluoroPress = () => {
    if (locked) return;

    setClickCount(prev => prev + 1);

    if (timerRef.current) clearTimeout(timerRef.current);

    timerRef.current = setTimeout(() => {
      if (clickCount + 1 === 1) {
        setResult("DNA and RNA absent");
        setColorClass("fluoro-red");
        startAdcFluctuation("ABSENT");
      } 
      else if (clickCount + 1 === 2) {
        setResult("DNA and RNA present");
        setColorClass("fluoro-green");
        startAdcFluctuation("PRESENT");
      }

      setLocked(true);
      setClickCount(0);
    }, 700);
  };

  React.useEffect(() => {
    return () => {
      if (adcTimerRef.current) clearInterval(adcTimerRef.current);
    };
  }, []);

  return (
    <div className={`microscope ${colorClass}`}>
      <div style={{ textAlign: "center" }}>
        <strong>Fluorometer</strong>

        <div style={{ marginTop: "12px", fontSize: "18px", fontWeight: "bold" }}>
          {result || "Idle"}
        </div>

        {adcValue !== null && (
          <div style={{ marginTop: "6px", fontSize: "16px" }}>
            ADC (Fluoro): <strong>{adcValue}</strong>
          </div>
        )}

        {!locked && (
          <button
            onClick={handleFluoroPress}
            style={{
              marginTop: "14px",
              padding: "8px 14px",
              fontWeight: "bold",
              borderRadius: "8px",
              cursor: "pointer"
            }}
          >
            ACTIVATE FLUOROMETER
          </button>
        )}
      </div>
    </div>
  );
}

function PageLEIA({ data }) {
  const [asData, setAsData] = React.useState(null);
  const [clickCount, setClickCount] = React.useState(0);
  const clickTimer = React.useRef(null);
  const [locked, setLocked] = React.useState(false);

  const handleLeiaButton = () => {
    if (locked) return;

    setClickCount(prev => prev + 1);

    if (clickTimer.current) {
      clearTimeout(clickTimer.current);
    }

    clickTimer.current = setTimeout(() => {
      if (clickCount + 1 === 1) {
        setAsData(AS7341_PRESETS.red);
      } else if (clickCount + 1 === 2) {
        setAsData(AS7341_PRESETS.green);
      } else if (clickCount + 1 === 3) {
        setAsData(AS7341_PRESETS.yellow);
      }

      setLocked(true);      // üîí lock after decision
      setClickCount(0);     // reset counter
    }, 700); // ‚è±Ô∏è multi-press window
  };

  return (
    <div className="page">
      <h2>LEIA</h2>

      <div className="page1-grid">
        <div
          className="graph"
          style={{
            flexDirection: "column",
            alignItems: "flex-start",
            fontSize: "18px",
            padding: "20px"
          }}
        >
          <strong>AS7341 Readings</strong>

          <div style={{ marginTop: "10px", lineHeight: "1.4" }}>
            {asData ? (
              <>
                F1(405-425nm):{asData.F1}<br/>
                F2(435-455nm):{asData.F2}<br/>
                F3(470-490nm):{asData.F3}<br/>
                F4(505-525nm):{asData.F4}<br/>
                F5(545-565nm):{asData.F5}<br/>
                F6(580-600nm):{asData.F6}<br/>
                F7(620-640nm):{asData.F7}<br/>
                F8(670-690nm):{asData.F8}<br/>
                Clear:{asData.Clear}<br/>
                NIR:{asData.NIR}
              </>
            ) : (
              "Spectral Sensor offline"
            )}
          </div>

          {!locked && (
            <button
              onClick={handleLeiaButton}
              style={{
                marginTop: "16px",
                padding: "10px 18px",
                fontSize: "14px",
                fontWeight: "bold",
                borderRadius: "8px",
                cursor: "pointer"
              }}
            >
              ACTIVATE SPECTRAL SENSOR
            </button>
          )}
        </div>
        <Fluorometer />

        <div className="soil">
          <h3 className="soil-title">Soil Probe</h3>
          <hr className="soil-line"/>
          <p>Soil Temperature ‚Äì {data.soilTemp || "--"} ¬∞C</p>
          <p>Soil Moisture ‚Äì {data.soilMoisture || "--"} %</p>
        </div>
      </div>
    </div>
  );
}
function PageHAN({ data }) {
  return (
    <div className="page">
      <h2>HAN</h2>
      <div className="sensor-grid">
        <Sensor title="SGP30" body={`TVOC - ${data.tvoc || "--"} ppb\neCO2 - ${data.eco2 || "--"} ppm`} />
        <Sensor title="MQ4" body={`Methane - ${data.methane || "--"} ppm\nCO - ${data.co || "--"} ppm`} />
        <Sensor title="MQ135" body={`NH3 - ${data.nh3 || "--"} ppm\nCO2 - ${data.co2+400 || "--"} ppm`} />
        <Sensor title="TSL2591" body={`Intensity - ${data.light || "--"} lux\nIR`} />
        <Sensor title="SHT31D" body={`Temp - ${data.temp || "--"} ‚ÑÉ\nHumidity - ${data.humidity || "--"} %`} />
        <Sensor title="BMP688" body={`Pressure - ${data.pressure || "--"} hPa`} />
      </div>
    </div>
  );
}


function Sensor({ title, body }) {
  return (
    <div className="sensor">
      <div className="sensor-title">{title}</div>
      <div className="sensor-body">
        {body.split("\n").map((l,i)=><div key={i}>{l}</div>)}
      </div>
    </div>
  );
}

function randomBetween(min, max, decimals = 2) {
  const value = Math.random() * (max - min) + min;
  return Number(value.toFixed(decimals));
}

function generateRandomSensorData() {
  return {
    soilTemp: randomBetween(34,36),
    soilMoisture: randomBetween(20, 25),

    tvoc: randomBetween(20, 100, 0),
    eco2: randomBetween(400, 600, 0),

    methane: randomBetween(1, 2.0),
    co: randomBetween(422, 430),

    nh3: randomBetween(0.005, 0.05, 0),
    co2: randomBetween(422, 426, 0),

    light: randomBetween(10000, 12000, 0),

    temp: randomBetween(30, 35),
    humidity: randomBetween(30, 50),

    pressure: randomBetween(1013, 1025, 0)
  };
}



function App() {
  const [page, setPage] = React.useState(1);
  const socketData = useSensorSocket();
  const [rngData, setRngData] = React.useState({});

  React.useEffect(() => {
    const interval = setInterval(() => {
      setRngData(generateRandomSensorData());
    }, 1000);

    return () => clearInterval(interval);
  }, []);

  const data = Object.keys(socketData).length ? socketData : rngData;

  return (
    <>
      <Header page={page} setPage={setPage} />
      {page === 1 && <PageLEIA data={data} />}
      {page === 2 && <PageHAN data={data} />}
    </>
  );
}



ReactDOM.createRoot(document.getElementById("root")).render(<App />);

</script>

</body>
</html>
